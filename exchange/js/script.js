import e from"./fb-helpers.js";import{drawGraph as t}from"./canvas.js";let DATA=[],keys=["USD","EUR","GBP","CAD","CHF","RUB","GEL"],time=null,dialogIsOpen=!1,urlBtc="https://blockchain.info/ticker",cells=document.getElementsByTagName("td"),clock=document.querySelector(".clock"),main=document.querySelector("main"),chartIcon=document.querySelector("svg"),dateRange=document.querySelector("h2"),flagsection=document.querySelector(".flagsection"),canvas=document.getElementById("canvas");function showDialog(){dialogIsOpen=!0;let e=document.createElement("div"),t=document.createElement("div"),n=document.createElement("p"),a=document.createElement("p"),l=document.createElement("input");e.classList.add("veil"),t.classList.add("dialog"),n.classList.add("info"),a.classList.add("author"),l.type="button",l.value="Հասկացա",n.textContent="Տվյալները վերցված են ՀՀ ԿԲ-ից և Blockchain.info կրիպտոարժույթային հարթակից",a.textContent="Coded by Emil Babayan, 2023, no rights reserved",l.addEventListener("click",function(){e.remove(),t.remove(),dialogIsOpen=!1}),t.append(n,l,a),main.append(e,t)}function setTime(){let e=new Date,t=e.getHours(),n=e.getMinutes(),a=e.getSeconds();clock.firstElementChild.textContent=`${t.toString().padStart(2,0)}:${n.toString().padStart(2,0)}:${a.toString().padStart(2,0)}`}function setDate(){let e=new Date,t=e.getMonth(),n=e.getDate(),a=e.getDay();document.querySelector(".datecell").textContent=`${["Հունվարի","Փետրվարի","Մարտի","Ապրիլի","Մայիսի","Հունիսի","Հուլիսի","Օգոստոսի","Սեպտեմբերի","Հոկտեմբերի","Նոյեմբերի","Դեկտեմբերի"][t]} ${n}, ${["կիրակի","երկուշաբթի","երեքշաբթի","չորեքշաբթի","հինգշաբթի","ուրբաթ","շաբաթ"][a]}`}function formatDiff(e){return Number.isInteger(e)?e+".00":Number(e+"0").toFixed(2)}async function fetchData(){let t=await e();renderData(t),DATA.push(...t),localStorage.setItem("exchangedata",JSON.stringify(t)),localStorage.setItem("dtex",Date.now())}function isFresh(){let e=+localStorage.getItem("dtex");if(!e||!localStorage.getItem("exchangedata"))return!1;let t=new Date,n=new Date(e),a=t.getUTCDate()===n.getUTCDate()&&t.getUTCMonth()===n.getUTCMonth()&&t.getUTCFullYear()===n.getUTCFullYear(),l=t.getUTCHours();return!(!a||l>=13&&13>n.getUTCHours())}function fillDataRange(e,t){return e=new Date(1e3*e.created.seconds),t=new Date(1e3*t.created.seconds),`${String(e.getDate()).padStart(2,0)}.${String(e.getMonth()+1).padStart(2,0)}.${e.getFullYear()} – ${String(t.getDate()).padStart(2,0)}.${String(t.getMonth()+1).padStart(2,0)}.${t.getFullYear()}`}function renderData(e=DATA){let n=e.at(-1),a=e.at(-2),l=flagsection.getElementsByTagName("h4"),s=document.querySelector("h4");s.textContent=n.USD,s.appendChild(Object.assign(document.createElement("sub"),{textContent:"֏"})),keys.forEach((s,o)=>{let i=(+n[s]).toFixed(2),c=+(i-a[s]).toFixed(2);cells[o+1].textContent=l[o].textContent=i,l[o].appendChild(Object.assign(document.createElement("sub"),{textContent:"֏"}));let r=cells[o+1].previousElementSibling,d=document.createElement("span"),g={less:{class:"fall",textContent:"▾",appendage:""},more:{class:"up",textContent:"▴",appendage:"+"},same:{class:"stable",textContent:"◬",appendage:""}},f=null;f=c<0?"less":c>0?"more":"same",r.classList.add(g[f].class),Object.assign(d,{textContent:g[f].textContent}),r.append(d,g[f].appendage,formatDiff(c)),dateRange.textContent=fillDataRange(e[0],e.at(-1)),t(canvas,e.map(e=>({value:e.USD,date:1e3*e.created.seconds})))}),fetch("https://blockchain.info/ticker").then(e=>e.json()).then(({USD:e})=>{cells[cells.length-1].textContent=splitBy(Math.floor(e["15m"]*n.USD).toString(),3,"_")})}function splitBy(e,t,n){let a="",l=0;for(let s=e.length-1;s>=0;s--)a=e[s]+a,l++,(l%=t)||(a=n+a);return a}function init(){let e=!isFresh();if(e)fetchData();else{let t=JSON.parse(localStorage.getItem("exchangedata"));DATA.push(...t),renderData(t)}}canvas.width=canvas.offsetParent.offsetWidth,canvas.height=301,flagsection.addEventListener("click",function(e){let n=e.target.dataset.key;if(!n)return;let a=e.target.closest(".flagpoint");console.log(a);let l=document.querySelector(".chart-hero");for(let s of(l.replaceChildren(...a.cloneNode(!0).children),a.classList.add("active"),flagsection.children))s.classList.toggle("active",a===s);let o=DATA.map(e=>({value:e[n],date:1e3*e.created.seconds}));t(canvas,o)}),window.addEventListener("keydown",function(e){"F12"==e.key&&e.preventDefault(),e.altKey&&e.ctrlKey&&"i"==e.key&&!dialogIsOpen&&showDialog()}),chartIcon.addEventListener("click",()=>{main.classList.toggle("charts")}),window.addEventListener("DOMContentLoaded",function(){setDate(),setTime(),time=setInterval(setTime,1e3),init()}),window.addEventListener("contextmenu",function(e){e.preventDefault()});